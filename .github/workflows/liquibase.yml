name: Liquibase CI/CD for PostgreSQL

on:
  push:
    paths:
      - 'changelog/**'
      - '.github/workflows/liquibase.yml'

jobs:
  liquibase-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Liquibase
      run: |
        curl -Lo liquibase.tar.gz https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz
        mkdir liquibase
        tar -xzf liquibase.tar.gz -C liquibase --strip-components=1
        sudo cp -r liquibase /opt/liquibase
        sudo ln -s /opt/liquibase/liquibase /usr/local/bin/liquibase


    - name: Run Liquibase Migrations
      run: |
        liquibase \
          --url="${{ secrets.DB_URI }}" \
          --changeLogFile=changelog/db.changelog-master.yaml \
          --username=postgres \
          --password=${{ secrets.DB_PASS }} \
          update
